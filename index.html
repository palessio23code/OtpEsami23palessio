<!DOCTYPE html>
<html lang="it" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ottimizzatore Piano Esami</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /*
     * v4.0 - Correzione Tocco Mobile
     * - Aggiunta una regola CSS per disabilitare l'effetto :hover sulle card della tabella su mobile.
     * - Questo impedisce che il colore cambi al tocco, risolvendo il problema di leggibilit√†.
     * - Mantenuta la nuova UI del modale a pannello per mobile.
    */
    :root {
      --background: #f1f5f9;
      --foreground-primary: #1e293b;
      --foreground-secondary: #475569;
      --foreground-muted: #64748b;
      --card-bg: rgba(255, 255, 255, 0.9);
      --input-bg: rgba(255, 255, 255, 0.8);
      --border-color: rgba(226, 232, 240, 0.7);
      --primary: #0ea5e9;
      --primary-hover: #0284c7;
      --primary-foreground: #ffffff;
      --accent-red: #ef4444;
      --text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    html.dark {
      --background: #0c1425;
      --foreground-primary: #f8fafc;
      --foreground-secondary: #cbd5e1;
      --foreground-muted: #94a3b8;
      --card-bg: rgba(24, 33, 52, 0.5);
      --input-bg: rgba(32, 42, 65, 0.7);
      --border-color: rgba(55, 65, 81, 0.5);
      --primary: #38bdf8;
      --primary-hover: #7dd3fc;
      --primary-foreground: #ffffff;
      --accent-red: #f87171;
      --text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    html {
      background-color: var(--background);
      color-scheme: light dark;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--foreground-secondary);
      transition: background-color 0.3s ease;
      opacity: 0;
      animation: fadeIn 0.5s ease-out forwards;
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    body.modal-open {
        overflow: hidden;
    }

    /* Sfondo Animato */
    #background-wrap {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: -1;
    }
    .blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
    }
    .blob1 { width: 400px; height: 400px; background: #38bdf8; top: -150px; left: -150px; animation: move 25s infinite alternate; }
    .blob2 { width: 300px; height: 300px; background: #818cf8; bottom: -100px; right: -100px; animation: move 30s infinite alternate; }
    .blob3 { width: 250px; height: 250px; background: #fb7185; bottom: 50px; left: 20%; animation: move 20s infinite alternate; }
    
    html.dark .blob { opacity: 0.25; }
    html.dark .blob1 { background: #0ea5e9; }
    html.dark .blob2 { background: #4f46e5; }
    html.dark .blob3 { background: #be185d; }

    @keyframes move {
        from { transform: translate(0, 0) rotate(0deg) scale(1); }
        to { transform: translate(100px, 50px) rotate(180deg) scale(1.2); }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in-up {
        opacity: 0;
        animation: fadeInUp 0.5s ease-out forwards;
    }
     @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Stili Glassmorphism */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 1.25rem;
      backdrop-filter: blur(16px) saturate(150%);
      -webkit-backdrop-filter: blur(16px) saturate(150%);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    html:not(.dark) .card {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.07), 0 8px 10px -6px rgba(0, 0, 0, 0.07);
    }
    h1, p, label, span, button, input, select { text-shadow: var(--text-shadow); }

    .input-base {
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--foreground-primary);
      border-radius: 0.5rem;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    html:not(.dark) .input-base {
        box-shadow: 0 2px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }
    .input-base:focus-within, .input-base:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
      border-color: var(--primary);
    }
    
    /* Bottoni */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: .5rem; font-weight: 600; border-radius: 9999px; transition: all 0.3s ease; }
    .btn-primary { 
      padding: 0.8rem 1.8rem; 
      color: #fff;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(2, 132, 199, 0.3);
      background-image: linear-gradient(to right, #38bdf8, #0ea5e9, #38bdf8);
      background-size: 200% auto;
      position: relative;
      overflow: hidden;
    }
    .btn-primary:hover { 
      background-position: right center;
      box-shadow: 0 6px 20px rgba(2, 132, 199, 0.4);
      transform: translateY(-3px); 
    }
    .btn-secondary { padding: .6rem 1.25rem; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--foreground-primary); }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background-color:rgba(14, 165, 233, 0.1); }
    .btn-danger { color: var(--accent-red); border-color: var(--accent-red); background: rgba(239, 68, 68, 0.05); }
    .btn-danger:hover { background-color: rgba(239, 68, 68, 0.1); }

    /* Componente Input Numerico */
    .number-input-container { display: flex; align-items: center; }
    .number-input-container button { width: 2.75rem; height: 2.75rem; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--foreground-muted); transition: background-color 0.2s; }
    .number-input-container button:hover { background-color: rgba(14, 165, 233, 0.1); }
    .number-input-container button:first-child { border-radius: 9999px 0 0 9999px; border-right: none; }
    .number-input-container button:last-child { border-radius: 0 9999px 9999px 0; border-left: none; }
    .number-input-container input { text-align: center; border-radius: 0 !important; height: 2.75rem; -moz-appearance: textfield; }
    .number-input-container input::-webkit-outer-spin-button,
    .number-input-container input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    /* Pillole */
    .date-pill { padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; cursor: pointer; transition: all 0.2s; background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--foreground-secondary); }
    .date-pill:hover { border-color: var(--primary); color: var(--primary); background-color: rgba(14, 165, 233, 0.1); transform: translateY(-1px); }

    /* Calendario Risultati */
    .calendar-icon { width: 4.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem; text-align: center; overflow: hidden; flex-shrink: 0; background: var(--card-bg); }
    .calendar-icon .month { background: var(--primary); color: var(--primary-foreground); font-weight: 700; font-size: .8rem; padding: 4px 0; text-transform: uppercase; }
    .calendar-icon .day { font-size: 1.75rem; font-weight: 800; padding: .25rem 0; color: var(--foreground-primary); }
    
    /* Tabella */
    .table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .table th, .table td { padding: .75rem .75rem; border-bottom: 1px solid var(--border-color); font-size: .9rem; text-align: left; }
    .table thead th { position: sticky; top: 0; background: var(--card-bg); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1; font-weight: 600; color: var(--foreground-primary); }
    .table tbody tr:last-child td { border-bottom: 0; }
    .table tbody tr { transition: background-color 0.2s; }
    .table tbody tr:hover { background-color: rgba(14, 165, 233, 0.06); }

    /* Badge */
    .badge { font-size: .75rem; padding: .25rem .6rem; border-radius: .5rem; background: rgba(14, 165, 233, .15); color: #0284c7; font-weight: 600;}
    html.dark .badge { color: #f0f9ff; background: var(--primary); }
    
    /* Animazione gradiente titolo */
    @keyframes gradient-animation {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .animated-gradient {
        background-size: 200% 200%;
        animation: gradient-animation 5s ease infinite;
    }
    
    /* Stili Modale */
    #manual-selection-modal {
        position: fixed;
        inset: 0;
        z-index: 50;
        background-color: rgba(0,0,0,0.6);
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity 0.3s ease-out;
        pointer-events: none;
    }
    #manual-selection-modal.open {
        opacity: 1;
        pointer-events: auto;
    }
    #manual-selection-modal.hidden {
        display: none;
    }

    #modal-content {
        /* Mobile-first: pannello a scorrimento */
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        position: absolute;
        bottom: 0; left: 0; right: 0;
        width: 100%;
        max-height: 90vh; 
        border-radius: 1.25rem 1.25rem 0 0;
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }

    #manual-selection-modal.open #modal-content {
        transform: translateY(0);
    }

    /* Stili Desktop: torna ad essere un riquadro centrato */
    @media (min-width: 768px) {
        #manual-selection-modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #modal-content {
            position: relative;
            transform: scale(0.95);
            border-radius: 1.25rem;
            width: 100%;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        #manual-selection-modal.open #modal-content {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Fix per visibilit√† modale in tema chiaro */
    html:not(.dark) #modal-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px) saturate(100%);
        -webkit-backdrop-filter: blur(8px) saturate(100%);
    }

    /* Custom Checkbox */
    input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        height: 1.1rem;
        width: 1.1rem;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.3rem;
        cursor: pointer;
        display: inline-block;
        position: relative;
        transition: all 0.2s ease;
    }
    input[type="checkbox"]:checked {
        background-color: var(--primary);
        border-color: var(--primary);
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        background-size: 100% 100%;
    }
    input[type="checkbox"]:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
    }
    input[type="checkbox"]:hover {
        border-color: var(--primary);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }
    html.dark ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    ::-webkit-scrollbar-thumb {
        background-color: rgba(14, 165, 233, 0.4);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }
    ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(14, 165, 233, 0.6);
    }
    html.dark ::-webkit-scrollbar-thumb {
        background-color: rgba(56, 189, 248, 0.4);
    }
    html.dark ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(56, 189, 248, 0.6);
    }
    
    /* Stili per Custom Select */
    .custom-select-container {
        position: relative;
    }
    .custom-select-trigger {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    .custom-select-options {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        width: 100%;
        z-index: 10;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s .2s;
        max-height: 200px;
        overflow-y: auto;
        padding: 0.5rem;
    }
    .custom-select-options.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s;
    }
    .custom-select-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 0.375rem;
        transition: background-color 0.2s;
        white-space: nowrap;
    }
    .custom-select-option:hover, .custom-select-option.selected {
        background-color: rgba(14, 165, 233, 0.1);
        color: var(--primary);
    }
    .custom-select-container select {
        display: none;
    }

    /* Stili per icona Date Picker */
    input[type="date"] {
        position: relative;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" viewBox="0 0 24 24"><path fill="%2364748b" d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>') no-repeat center;
        background-size: 1.1rem;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
    }
    html.dark input[type="date"]::-webkit-calendar-picker-indicator {
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" viewBox="0 0 24 24"><path fill="%2394a3b8" d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>') no-repeat center;
        background-size: 1.1rem;
    }

    /* Animazione a cascata per i risultati */
    @keyframes stagger-in {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .stagger-item {
        opacity: 0; /* Inizia invisibile */
        animation: stagger-in 0.5s ease-out forwards;
    }
    
    html.dark .stagger-item:hover {
        background-color: rgba(14, 165, 233, 0.1);
        border-color: var(--primary);
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
    }

    #toast {
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Stili per la responsivit√† mobile (da 768px in gi√π) */
    @media screen and (max-width: 768px) {
      .table thead {
        display: none;
      }
      .table, .table tbody, .table tr, .table td {
        display: block;
        width: 100%;
      }
      .table tr {
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 0.5rem;
        background: var(--input-bg);
      }
      /* ======== NUOVA REGOLA PER FIXARE IL COLORE AL TOCCO ======== */
      .table tbody tr:hover {
          background-color: var(--input-bg); /* Mantiene lo stesso colore di sfondo al tocco */
      }
      .table td {
        text-align: right;
        position: relative;
        padding-left: 50%;
        border-bottom: 1px solid var(--border-color);
        padding-top: .75rem;
        padding-bottom: .75rem;
      }
      .table tr:last-child {
        margin-bottom: 0;
      }
      .table td:last-child {
        border-bottom: 0;
      }
      .table td::before {
        content: attr(data-label);
        position: absolute;
        left: 0.75rem;
        width: calc(50% - 1.5rem);
        text-align: left;
        font-weight: 600;
        color: var(--foreground-primary);
        white-space: nowrap;
      }
      .table td:nth-child(1), .table td:nth-child(2) {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-left: .75rem;
      }
      .table td:nth-child(1)::before, .table td:nth-child(2)::before {
          position: static;
          width: auto;
          font-weight: normal;
          color: var(--foreground-secondary);
      }
    }
  </style>
</head>

<body class="antialiased">
  <div id="background-wrap">
      <div class="blob blob1"></div>
      <div class="blob blob2"></div>
      <div class="blob blob3"></div>
  </div>

  <div class="container mx-auto p-4 md:p-8 max-w-5xl">
    
    <header class="flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center mb-8 gap-4">
      <div class="text-center sm:text-left">
         <h1 class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-cyan-400 animated-gradient">Ottimizzatore Piano Esami</h1>
        <p class="text-foreground-secondary mt-2 max-w-xl mx-auto sm:mx-0">Carica il tuo file JSON degli appelli, imposta i vincoli e trova il piano di studi perfetto per te.</p>
      </div>
      <div>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-500/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" aria-label="Toggle light/dark theme">
          <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/></svg>
          <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 0 1 8.646 3.646 9.003 9.003 0 0 0 12 21a9.003 9.003 0 0 0 8.354-5.646z"/></svg>
        </button>
      </div>
    </header>

    <section class="card p-5 md:p-8 space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="file-input" class="block text-sm font-medium mb-2 text-foreground-primary">File appelli (.json)</label>
          <div id="file-dropzone" class="mt-1 flex justify-center p-6 border-2 border-dashed rounded-lg transition-colors duration-300 border-border-color hover:border-primary cursor-pointer">
            <div class="space-y-2 text-center">
              <svg class="mx-auto h-12 w-12 text-foreground-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75z" /></svg>
              <div class="flex flex-col sm:flex-row text-sm justify-center items-center text-foreground-secondary">
                <span class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover">
                  <span>Carica un file</span>
                  <input id="file-input" name="file-input" type="file" class="sr-only" accept=".json">
                </span>
                <p class="pl-1">o trascinalo qui</p>
              </div>
              <p id="file-name" class="text-xs text-foreground-muted pt-1"></p>
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label for="free-sede-select" class="block text-sm font-medium text-foreground-primary">Sede gratuita (opzionale)</label>
          <div class="relative">
            <select id="free-sede-select">
              <option value="">Nessuna</option>
              <option value="Villa Vannucchi">Villa Vannucchi</option>
              <option value="Piazza Oderico da Pordenone">Piazza Oderico da Pordenone</option>
              <option value="Altro">Altro...</option>
            </select>
          </div>
          <input id="free-sede-other" type="text" placeholder="Inserisci sede personalizzata" class="hidden mt-2 w-full input-base p-2.5 h-[2.75rem]">
          <p class="text-xs text-foreground-muted pt-1">Match tollerante: non serve scriverla identica al database.</p>
        </div>
      </div>

      <div class="border-t border-border-color"></div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        <div class="sm:col-span-2 md:col-span-1">
          <div class="flex justify-between items-center mb-1">
            <label for="max-exams" class="block text-sm font-medium text-foreground-primary">Max esami totali</label>
             <button type="button" class="date-pill" data-value-target="max-exams" data-value="5">5</button>
          </div>
          <div class="number-input-container"><button type="button" data-action="decrement" data-target="max-exams">-</button><input id="max-exams" type="number" value="10" min="1" class="w-full input-base p-2"><button type="button" data-action="increment" data-target="max-exams">+</button></div>
        </div>
        <div>
          <label for="max-per-day" class="block text-sm font-medium mb-1 text-foreground-primary">Max esami per giorno</label>
          <div class="number-input-container"><button type="button" data-action="decrement" data-target="max-per-day">-</button><input id="max-per-day" type="number" value="2" min="1" class="w-full input-base p-2"><button type="button" data-action="increment" data-target="max-per-day">+</button></div>
        </div>
        <div>
          <label for="min-gap-days" class="block text-sm font-medium mb-1 text-foreground-primary">Gap minimo (giorni)</label>
          <div class="number-input-container"><button type="button" data-action="decrement" data-target="min-gap-days">-</button><input id="min-gap-days" type="number" value="0" min="0" class="w-full input-base p-2"><button type="button" data-action="increment" data-target="min-gap-days">+</button></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-y-6 md:gap-x-6">
        <div>
            <div class="flex justify-between items-center mb-2">
                <label for="min-date" class="block text-sm font-medium text-foreground-primary">Data inizio</label>
                <div class="relative">
                    <select id="quick-date-select-start" class="date-pill">
                        <option value="">Rapide...</option>
                        <option value="today">Oggi</option>
                        <option value="2025-11-01">01/11/25</option>
                    </select>
                </div>
            </div>
          <div class="relative input-wrapper-date">
            <input id="min-date" type="date" class="w-full input-base p-2 pl-3 h-[2.75rem]">
          </div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-2">
                 <label for="max-date" class="block text-sm font-medium text-foreground-primary">Data massima</label>
                 <div class="relative">
                    <select id="quick-date-select-end" class="date-pill">
                        <option value="">Fine mese...</option>
                        <option value="2025-12-31">Dicembre '25</option>
                        <option value="2026-01-31">Gennaio '26</option>
                        <option value="2026-02-28">Febbraio '26</option>
                        <option value="2026-03-31">Marzo '26</option>
                        <option value="2026-04-30">Aprile '26</option>
                        <option value="2026-05-31">Maggio '26</option>
                        <option value="2026-06-30">Giugno '26</option>
                        <option value="2026-07-31">Luglio '26</option>
                    </select>
                 </div>
            </div>
          <div class="relative input-wrapper-date">
            <input id="max-date" type="date" class="w-full input-base p-2 pl-3 h-[2.75rem]">
          </div>
        </div>
        <div class="flex flex-col">
          <label for="max-sedi" class="block text-sm font-medium mb-2">Max sedi</label>
          <div class="number-input-container mt-auto"><button type="button" data-action="decrement" data-target="max-sedi">-</button><input id="max-sedi" type="number" value="2" min="1" class="w-full input-base p-2"><button type="button" data-action="increment" data-target="max-sedi">+</button></div>
        </div>
      </div>

      <div class="border-t border-border-color pt-6">
        <button id="open-manual-modal-btn" class="w-full flex items-center justify-between p-4 rounded-lg border border-border-color cursor-pointer transition-all hover:bg-black/5 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed group" disabled>
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-foreground-muted group-hover:text-primary transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg>
            <div>
                <span class="font-semibold text-foreground-primary">Selezione manuale appelli</span>
                <p id="manual-selection-summary" class="text-xs text-foreground-muted">Carica un file JSON per abilitare</p>
            </div>
          </div>
           <span id="manual-selection-badge" class="badge hidden">0 includi ¬∑ 0 escludi</span>
        </button>
      </div>

      <div class="text-center pt-4">
        <button id="run-btn" class="btn btn-primary !text-lg group">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="transition-transform group-hover:scale-110" viewBox="0 0 16 16"><path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"/></svg>
          Calcola Piano Ottimale
        </button>
      </div>
    </section>

    <section id="results-container" class="mt-8 card p-5 md:p-8 hidden">
      <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3 mb-4">
        <h2 class="text-2xl font-bold text-foreground-primary">Piano Ottimizzato</h2>
        <button id="save-plan-btn" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z"/></svg>
            Salva Piano
        </button>
      </div>
      <div id="results"></div>
    </section>

    <section id="saved-plans-container" class="mt-8 card p-5 md:p-8 hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-foreground-primary">Piani Salvati</h2>
        <button id="clear-plans-btn" class="btn btn-secondary btn-danger">Pulisci Tutto</button>
      </div>
      <div id="saved-plans" class="space-y-4"></div>
    </section>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-foreground-primary text-background py-2 px-5 rounded-full shadow-lg opacity-0 transition-all duration-300 flex items-center gap-3 transform translate-y-4">
    <span id="toast-message">Piano salvato con successo!</span>
  </div>

  <div id="manual-selection-modal" class="hidden">
      <div id="modal-content">
          <div class="flex items-center justify-between p-4 border-b border-border-color flex-shrink-0">
              <h3 class="text-xl font-bold text-foreground-primary">Selezione Manuale Appelli</h3>
              <button id="close-manual-modal-btn" class="p-2 rounded-full hover:bg-slate-500/10">
                  <svg class="w-6 h-6 text-foreground-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
          </div>
          <div class="p-4 space-y-4 overflow-y-auto">
              <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                  <div class="relative w-full md:flex-1">
                      <input id="search-input" type="text" placeholder="Cerca per corso, sede, data..." class="w-full input-base pl-10 pr-3 py-2 h-[2.75rem]">
                      <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-foreground-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/></svg>
                  </div>
                  <div class="flex items-center gap-4">
                      <div class="flex items-center gap-2">
                          <input id="show-only-picked" type="checkbox">
                          <label for="show-only-picked" class="text-sm">Mostra solo selezionati</label>
                      </div>
                      <button id="refresh-list" class="btn btn-secondary !py-2 !px-3 !rounded-md !text-sm">Aggiorna</button>
                  </div>
              </div>
              <div class="flex flex-wrap gap-2">
                  <button id="select-all-include" class="btn btn-secondary !text-sm !py-1 !px-3 !rounded-md">Includi tutti i risultati</button>
                  <button id="select-all-exclude" class="btn btn-secondary !text-sm !py-1 !px-3 !rounded-md">Escludi tutti i risultati</button>
                  <button id="unselect-all" class="btn btn-secondary !text-sm !py-1 !px-3 !rounded-md">Deseleziona tutti</button>
              </div>
              <div class="overflow-auto border border-border-color rounded-lg bg-background/80">
                  <table class="table">
                      <thead>
                          <tr>
                              <th style="width:80px">Includi</th>
                              <th style="width:80px">Escludi</th>
                              <th>Data</th>
                              <th>Ora</th>
                              <th>Corso</th>
                              <th>Sede</th>
                          </tr>
                      </thead>
                      <tbody id="exam-list"></tbody>
                  </table>
              </div>
          </div>
           <div class="p-4 border-t border-border-color text-right">
                <button id="confirm-selection-btn" class="btn btn-secondary !rounded-md !px-5">Conferma Selezione</button>
           </div>
      </div>
  </div>


  <script>
    // ===== Stato (LOGICA NON MODIFICATA) =====
    let currentPlan = [];
    let rawJson = [];
    let pickedInclude = new Set();
    let pickedExclude = new Set();
    let totalSediCount = 0;

    // ===== Utils (LOGICA NON MODIFICATA) =====
    function parseDateTimeIT(s){ if(!s) return null; const m=String(s).trim().match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})(?:\s*(?:ore\s*)?(\d{2}):(\d{2}))?$/i); if(!m) return null; const[,dd,mm,yyyy,HH,MM]=m; const d=new Date(`${yyyy}-${mm}-${dd}T${HH||'00'}:${MM||'00'}:00`); return isNaN(d)?null:d; }
    const formatDate=d=>d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
    const formatTime=d=>d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
    const prettySede=s=>s?String(s).replace(/^\s*Sede\s+/i,'').replace(/\s+/g,' ').trim():'';
    const normalizeSede=s=>prettySede(s).replace(/[(),]/g,' ').replace(/\s+/g,' ').normalize('NFD').replace(/[\u0300-\u036f]/gu,'').toLowerCase().trim();
    function examId(e){ const dt=parseDateTimeIT(e.data); return [String(e.corso), dt?dt.toISOString():String(e.data), normalizeSede(e.sede||'')].join('|'); }
    function showToast(msg, type='success'){
        const el=document.getElementById('toast');
        document.getElementById('toast-message').textContent=msg;
        el.classList.remove('opacity-0', 'translate-y-4');
        setTimeout(()=>{ el.classList.add('opacity-0', 'translate-y-4'); }, 2500);
    }

    function normTxt(s){ return String(s||'').replace(/_/g,' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/gu,'').replace(/[^\p{L}\p{N}\s:\/-]/gu,' ').replace(/\s+/g,' ').trim(); }
    function smartMatch(haystack, needle){ if(!needle) return true; const H=normTxt(haystack); const N=normTxt(needle); if(!N) return true; if(H.includes(N)) return true; const tokens=N.split(' ').filter(Boolean); return tokens.every(t=>H.includes(t)); }

    // ===== Tema & UI =====
    document.getElementById('theme-toggle').addEventListener('click',()=>{
      const isDark=document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-icon-light').classList.toggle('hidden',isDark);
      document.getElementById('theme-icon-dark').classList.toggle('hidden',!isDark);
    });
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-icon-light').classList.remove('hidden');
        document.getElementById('theme-icon-dark').classList.add('hidden');
    }
    
    document.querySelectorAll('[data-value-target]').forEach(pill => {
        pill.addEventListener('click', () => {
             const targetId = pill.dataset.valueTarget;
             const value = pill.dataset.value;
             const targetInput = document.getElementById(targetId);
             if (targetInput) {
                targetInput.value = value;
             }
        });
    });

    document.getElementById('quick-date-select-start').addEventListener('change', e => {
        const value = e.target.value;
        const targetInput = document.getElementById('min-date');
        if (!targetInput || !value) return;
        if (value === 'today') {
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            targetInput.value = today.toISOString().split('T')[0];
        } else {
            targetInput.value = value;
        }
    });

    document.getElementById('quick-date-select-end').addEventListener('change', e => {
        const value = e.target.value;
        const targetInput = document.getElementById('max-date');
        if (!targetInput || !value) return;
        targetInput.value = value;
    });


    document.querySelectorAll('[data-action="increment"],[data-action="decrement"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const input=document.getElementById(btn.dataset.target); if(!input) return;
        let v=Number(input.value)||0; const step=Number(input.step)||1;
        input.value = btn.dataset.action==='increment' ? v+step : Math.max(Number(input.min)||-Infinity, v-step);
      });
    });
    document.getElementById('free-sede-select').addEventListener('change',e=>{
      const other=document.getElementById('free-sede-other');
      if(e.target.value==='Altro') other.classList.remove('hidden'); else { other.classList.add('hidden'); other.value=''; }
    });
    
    // ===== Dropzone (LOGICA NON MODIFICATA) =====
    const dropzone=document.getElementById('file-dropzone'), fileInput=document.getElementById('file-input'), fileNameDisplay=document.getElementById('file-name');
    dropzone.addEventListener('click',()=>fileInput.click());
    dropzone.addEventListener('dragover',e=>{ e.preventDefault(); dropzone.classList.add('border-primary','bg-primary/10'); });
    dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('border-primary','bg-primary/10'));
    dropzone.addEventListener('drop',e=>{ e.preventDefault(); dropzone.classList.remove('border-primary','bg-primary/10'); if(e.dataTransfer.files.length){ fileInput.files=e.dataTransfer.files; updateFileName(fileInput.files[0]); loadFile(); }});
    fileInput.addEventListener('change',()=>{ if(fileInput.files.length){ updateFileName(fileInput.files[0]); loadFile(); }});
    function updateFileName(file){ fileNameDisplay.textContent=file?file.name:''; }
    function loadFile(){
      const f=fileInput.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=e=>{
        try{ 
            rawJson=JSON.parse(e.target.result); 
            const uniqueSedi = new Set(rawJson.map(e => prettySede(e.sede || '')));
            totalSediCount = uniqueSedi.size;
            document.getElementById('open-manual-modal-btn').disabled = false;
            buildExamList(); 
            updateManualSelectionSummary(); 
            showToast('File caricato con successo'); 
        }
        catch(err){ showToast('Errore: file JSON non valido.', 'error'); console.error(err); }
      }; r.readAsText(f);
    }

    // ===== Logica Modale (Aggiornata per la nuova UI) =====
    const openModalBtn = document.getElementById('open-manual-modal-btn');
    const closeModalBtn = document.getElementById('close-manual-modal-btn');
    const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
    const modal = document.getElementById('manual-selection-modal');
    
    function openManualSelectionModal() {
        if (openModalBtn.disabled) return;
        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        setTimeout(() => {
            modal.classList.add('open');
        }, 10);
    }

    function closeManualSelectionModal() {
        modal.classList.remove('open');
        setTimeout(() => {
            if (!modal.classList.contains('open')) {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        }, 300);
    }

    openModalBtn.addEventListener('click', openManualSelectionModal);
    closeModalBtn.addEventListener('click', closeManualSelectionModal);
    confirmSelectionBtn.addEventListener('click', closeManualSelectionModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeManualSelectionModal();
        }
    });

    // ===== Ricerca / Tabella (LOGICA NON MODIFICATA) =====
    const searchInput=document.getElementById('search-input');
    const showOnlyPicked=document.getElementById('show-only-picked');
    
    document.getElementById('refresh-list').addEventListener('click',()=>{ buildExamList(); updateManualSelectionSummary(); showToast('Elenco aggiornato'); });
    ['input','change'].forEach(ev=>searchInput.addEventListener(ev,()=>{ buildExamList(); updateManualSelectionSummary(); }));
    showOnlyPicked.addEventListener('change',()=>{ buildExamList(); updateManualSelectionSummary(); });
    document.getElementById('min-date').addEventListener('change',()=>{ buildExamList(); updateManualSelectionSummary(); });
    document.getElementById('max-date').addEventListener('change',()=>{ buildExamList(); updateManualSelectionSummary(); });

    function filteredRaw(){
      const min=document.getElementById('min-date').value?new Date(document.getElementById('min-date').value+'T00:00:00'):null;
      const max=document.getElementById('max-date').value?new Date(document.getElementById('max-date').value+'T23:59:59'):null;
      return (rawJson||[]).filter(e=>{
        const tipo=String(e.tipo||'').toUpperCase().trim();
        const mod=String(e.modalita||'').toLowerCase().trim();
        if(!(tipo==='ONLINE'||mod.includes('online')||mod.includes('remoto'))) return false;
        const dt=parseDateTimeIT(e.data); if(!dt) return false;
        if(min && dt<min) return false;
        if(max && dt>max) return false;
        return true;
      });
    }
    function currentRows(){
      const term=searchInput.value;
      const onlyPicked=showOnlyPicked.checked;
      return filteredRaw()
        .map(e=>{ const dt=parseDateTimeIT(e.data); const corso=String(e.corso); const sede=prettySede(e.sede||''); const searchBlob = `${corso} ${sede} ${formatDate(dt)} ${formatTime(dt)}`; return { id:examId(e), corso, sede, dt, searchBlob }; })
        .filter(r=>smartMatch(r.searchBlob, term))
        .filter(r=>!onlyPicked || pickedInclude.has(r.id) || pickedExclude.has(r.id))
        .sort((a,b)=>a.dt-b.dt);
    }

    function buildExamList(){
      const body=document.getElementById('exam-list'); body.innerHTML='';
      currentRows().forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Includi"><input type="checkbox" data-id="${r.id}" data-action="include" ${pickedInclude.has(r.id) ? 'checked' : ''}></td>
          <td data-label="Escludi"><input type="checkbox" data-id="${r.id}" data-action="exclude" ${pickedExclude.has(r.id) ? 'checked' : ''}></td>
          <td data-label="Data">${formatDate(r.dt)}</td>
          <td data-label="Ora">${formatTime(r.dt)}</td>
          <td data-label="Corso">${r.corso.replace(/_/g,' ')}</td>
          <td data-label="Sede">${r.sede}</td>
        `;
        body.appendChild(tr);
      });
    }
    document.getElementById('exam-list').addEventListener('change', e => {
        if(e.target.type === 'checkbox') {
            const id = e.target.dataset.id;
            const action = e.target.dataset.action;
            const isChecked = e.target.checked;
            
            if (action === 'include') {
                if (isChecked) {
                    pickedInclude.add(id);
                    pickedExclude.delete(id);
                    const excludeCheckbox = modal.querySelector(`input[data-id="${id}"][data-action="exclude"]`);
                    if (excludeCheckbox) excludeCheckbox.checked = false;
                } else {
                    pickedInclude.delete(id);
                }
            } else if (action === 'exclude') {
                if (isChecked) {
                    pickedExclude.add(id);
                    pickedInclude.delete(id);
                    const includeCheckbox = modal.querySelector(`input[data-id="${id}"][data-action="include"]`);
                    if (includeCheckbox) includeCheckbox.checked = false;
                } else {
                    pickedExclude.delete(id);
                }
            }
            updateManualSelectionSummary();
        }
    });

    function updateManualSelectionSummary(){ 
        const summaryText = document.getElementById('manual-selection-summary');
        const summaryBadge = document.getElementById('manual-selection-badge');
        
        if (!rawJson || rawJson.length === 0) {
            summaryText.textContent = 'Carica un file JSON per abilitare';
            summaryBadge.classList.add('hidden');
            return;
        }
        
        summaryText.textContent = `Gestisci inclusioni/esclusioni (${totalSediCount} sedi caricate)`;
        summaryBadge.textContent = `${pickedInclude.size} includi ¬∑ ${pickedExclude.size} escludi`;
        summaryBadge.classList.remove('hidden');
    }

    document.getElementById('select-all-include').addEventListener('click',()=>{ currentRows().forEach(r=>{ pickedInclude.add(r.id); pickedExclude.delete(r.id); }); buildExamList(); updateManualSelectionSummary(); });
    document.getElementById('select-all-exclude').addEventListener('click',()=>{ currentRows().forEach(r=>{ pickedExclude.add(r.id); pickedInclude.delete(r.id); }); buildExamList(); updateManualSelectionSummary(); });
    document.getElementById('unselect-all').addEventListener('click',()=>{ currentRows().forEach(r=>{ pickedExclude.delete(r.id); pickedInclude.delete(r.id); }); buildExamList(); updateManualSelectionSummary(); });

    // ===== Optimizer (LOGICA NON MODIFICATA) =====
    function optimize(allExams, params){
      let df=allExams.map(e=>({...e, data_dt:parseDateTimeIT(e.data)})).filter(e=>e.data_dt instanceof Date && !isNaN(e.data_dt)).map(e=>({...e, sede_pretty:prettySede(e.sede), sede_clean:normalizeSede(e.sede), course:String(e.corso), id:examId(e)}));
      df=df.filter(e=>{ const tipo=String(e.tipo||'').toUpperCase().trim(); const mod=String(e.modalita||'').toLowerCase().trim(); if(!(tipo==='ONLINE'||mod.includes('online')||mod.includes('remoto'))) return false; if(params.min_date && e.data_dt < new Date(params.min_date+'T00:00:00')) return false; if(params.max_date && e.data_dt > new Date(params.max_date+'T23:59:59')) return false; return true; });
      if(params.excluded_ids?.length){ const ex=new Set(params.excluded_ids); df=df.filter(e=>!ex.has(e.id)); }
      df.forEach(e=>e.day=new Date(e.data_dt.getFullYear(), e.data_dt.getMonth(), e.data_dt.getDate()));
      const totalUniqueCourses=new Set(df.map(e=>e.course)).size;
      if(!df.length) return { chosen:[], stats:{ total_unique_courses:0, planned_unique:0, unplanned_courses:[], used_sedi:[], max_sedi:params.max_sedi, reached_max_sedi:false, locked_not_scheduled:[] } };
      let chosen=[], chosen_courses=new Set(), usedSedi=new Set(), perDay={}, locked_not_scheduled=[];
      if(params.locked_ids?.length){ const locked=df.filter(e=>params.locked_ids.includes(e.id)).sort((a,b)=>a.data_dt-b.data_dt); for(const e of locked){ if(chosen.length>=params.max_exams) break; const dayKey=e.day.getTime(); if((perDay[dayKey]||0)>=params.max_per_day){ locked_not_scheduled.push(e); continue; } const tooClose=chosen.some(c=>Math.abs((e.day-c.day)/86400000)<params.min_gap_days && (e.day-c.day)!==0); if(tooClose){ locked_not_scheduled.push(e); continue; } if(usedSedi.size>=params.max_sedi && !usedSedi.has(e.sede_clean)){ locked_not_scheduled.push(e); continue; } chosen.push({ Corso:e.course, Data:formatDate(e.data_dt), Ora:formatTime(e.data_dt), Sede:e.sede_pretty, sede_clean:e.sede_clean, dt:e.data_dt, day:e.day, Chiusura:e.chiusura_prenotazioni||"" }); chosen_courses.add(e.course); usedSedi.add(e.sede_clean); perDay[dayKey]=(perDay[dayKey]||0)+1; } }
      if(params.free_sede_exact){ const free=df.filter(e=>normalizeSede(e.sede).includes(normalizeSede(params.free_sede_exact)) && !(params.excluded_ids||[]).includes(e.id)).sort((a,b)=>a.data_dt-b.data_dt); for(const e of free){ if(chosen.length>=params.max_exams) break; if(chosen_courses.has(e.course)) continue; const dayKey=e.day.getTime(); if((perDay[dayKey]||0)>=params.max_per_day) continue; const tooClose=chosen.some(c=>Math.abs((e.day-c.day)/86400000)<params.min_gap_days && (e.day-c.day)!==0); if(tooClose) continue; if(usedSedi.size>=params.max_sedi && !usedSedi.has(e.sede_clean)) continue; chosen.push({ Corso:e.course, Data:formatDate(e.data_dt), Ora:formatTime(e.data_dt), Sede:e.sede_pretty, sede_clean:e.sede_clean, dt:e.data_dt, day:e.day, Chiusura:e.chiusura_prenotazioni||"" }); chosen_courses.add(e.course); usedSedi.add(e.sede_clean); perDay[dayKey]=(perDay[dayKey]||0)+1; } }
      let reachedMaxSedi=false;
      while(chosen.length<params.max_exams){ if(usedSedi.size>=params.max_sedi){ reachedMaxSedi=true; break; } const candid=[...new Set(df.filter(e=>!chosen_courses.has(e.course) && !(params.excluded_ids||[]).includes(e.id)).map(e=>e.sede_clean))].filter(s=>!usedSedi.has(s)); if(!candid.length) break; let bestSede=null, bestSet=[], bestLen=-1; for(const sede of candid){ const exams=df.filter(e=>e.sede_clean===sede && !chosen_courses.has(e.course) && !(params.excluded_ids||[]).includes(e.id)).sort((a,b)=>a.data_dt-b.data_dt); const tmp=[], perDayTmp={...perDay}; for(const e of exams){ if(chosen.length+tmp.length>=params.max_exams) break; const dayKey=e.day.getTime(); if((perDayTmp[dayKey]||0)>=params.max_per_day) continue; const tooClose=[...chosen,...tmp].some(c=>Math.abs((e.day-c.day)/86400000)<params.min_gap_days && (e.day-c.day)!==0); if(tooClose) continue; tmp.push(e); perDayTmp[dayKey]=(perDayTmp[dayKey]||0)+1; } if(tmp.length>bestLen){ bestLen=tmp.length; bestSede=sede; bestSet=tmp; } } if(!bestSede||!bestSet.length) break; bestSet.forEach(e=>{ chosen.push({ Corso:e.course, Data:formatDate(e.data_dt), Ora:formatTime(e.data_dt), Sede:e.sede_pretty, sede_clean:e.sede_clean, dt:e.data_dt, day:e.day, Chiusura:e.chiusura_prenotazioni||"" }); chosen_courses.add(e.course); const k=e.day.getTime(); perDay[k]=(perDay[k]||0)+1; }); usedSedi.add(bestSede); }
      const plannedUnique=new Set(chosen.map(c=>c.Corso)).size; const unplannedCourses=[...new Set(df.map(e=>e.course))].filter(c=>!new Set(chosen.map(x=>x.Corso)).has(c));
      return { chosen: chosen.map(c=>({...c, dt:c.dt.toISOString()})), stats:{ total_unique_courses: totalUniqueCourses, planned_unique: plannedUnique, unplanned_courses: unplannedCourses, used_sedi:[...usedSedi], max_sedi:params.max_sedi, reached_max_sedi:reachedMaxSedi, locked_not_scheduled:(locked_not_scheduled||[]).map(e=>({ corso:e.course, when:formatDate(e.data_dt)+' '+formatTime(e.data_dt), sede:e.sede_pretty })) } };
    }

    // ===== Calendar (LOGICA NON MODIFICATA) =====
    function computeManuallyExcludedCoursesForPeriod(){ const idsInPeriod=new Set(filteredRaw().map(e=>examId(e))); const excludedIds=[...pickedExclude].filter(id=>idsInPeriod.has(id)); const idToCourse=new Map(filteredRaw().map(e=>[examId(e), String(e.corso)])); const uniqueCourses=[...new Set(excludedIds.map(id=>idToCourse.get(id)))].filter(Boolean); return uniqueCourses; }
    function addToGoogleCalendar(exam){ const start=new Date(exam.dt).toISOString().replace(/-|:|\.\d\d\d/g,''); const end=new Date(new Date(exam.dt).getTime()+60*60*1000).toISOString().replace(/-|:|\.\d\d\d/g,''); const url=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Esame: '+exam.Corso)}&dates=${start}/${end}&details=${encodeURIComponent('Esame di '+exam.Corso)}&location=${encodeURIComponent(exam.Sede)}`; window.open(url,'_blank'); }

    // ===== Output (LOGICA NON MODIFICATA) =====
    function displayResults(payload){
      const out=document.getElementById('results'), container=document.getElementById('results-container');
      const res=!payload.chosen?{chosen:payload,stats:{}}:(Array.isArray(payload)?{chosen:payload,stats:{total_unique_courses:payload.length,planned_unique:payload.length,unplanned_courses:[],used_sedi:[...new Set(payload.map(x=>x.sede_clean))],max_sedi:Infinity,reached_max_sedi:false,locked_not_scheduled:[]}}:payload);
      currentPlan=res.chosen.map(c=>({...c,dt:new Date(c.dt)})); const stats=res.stats||{};
      
      container.classList.remove('hidden');
      container.classList.add('fade-in-up');
      out.innerHTML = ''; // Pulisci i risultati precedenti

      if(!currentPlan.length){ out.innerHTML=`<div class="rounded-lg border border-amber-400 bg-amber-50 dark:bg-amber-900/20 p-4 text-amber-800 dark:text-amber-300">Nessun risultato con i vincoli correnti.</div>`; document.getElementById('save-plan-btn').classList.add('hidden'); return; }
      document.getElementById('save-plan-btn').classList.remove('hidden');
      
      let headerHTML=''; const manuallyExcludedCourses=computeManuallyExcludedCoursesForPeriod();
      if(manuallyExcludedCourses.length){ headerHTML+=`<div class="rounded-lg border border-blue-400 bg-blue-50 dark:bg-blue-900/20 p-3 text-blue-700 dark:text-blue-200 mb-3"><b>Esami esclusi manualmente</b>: ${manuallyExcludedCourses.map(s=>s.replace(/_/g,' ')).join(' ¬∑ ')}</div>`; }
      if(stats.unplanned_courses?.length){ headerHTML+=`<div class="rounded-lg border border-amber-400 bg-amber-50 dark:bg-amber-900/20 p-3 text-amber-800 dark:text-amber-300 mb-3"><b>Esami non pianificati</b>: ${stats.unplanned_courses.map(s=>s.replace(/_/g,' ')).join(' ¬∑ ')}</div>`; }
      if(stats.locked_not_scheduled?.length){ headerHTML+=`<div class="rounded-lg border border-red-400 bg-red-50 dark:bg-red-900/20 p-3 text-red-700 dark:text-red-300 mb-3"><b>"Includi" non inseriti per conflitti</b>: <ul class="list-disc ml-5 text-sm mt-1">${stats.locked_not_scheduled.map(x=>`<li>${x.corso.replace(/_/g,' ')} ‚Äî ${x.when}</li>`).join('')}</ul></div>`; }
      
      const uniqueSedi=[...new Set(currentPlan.map(r=>r.Sede))]; const groups={}; 
      currentPlan.forEach(r=>{ (groups[r.Data]||(groups[r.Data]=[])).push(r); });
      
      let resultsHTML = `${headerHTML}<div class='mb-4 text-sm p-3 bg-slate-500/10 rounded-lg'>Sedi utilizzate: <b>${uniqueSedi.length}</b> ‚Äî ${uniqueSedi.join(' ¬∑ ')}</div>`;
      let resultCounter = 0;

      Object.keys(groups).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-'))).forEach(dateKey=>{
        groups[dateKey].sort((a,b)=>a.dt-b.dt).forEach(e=>{
          const examJson=JSON.stringify(e).replace(/"/g,'&quot;'), d=e.dt, day=d.getDate(), month=d.toLocaleDateString('it-IT',{month:'short'}).replace('.','');
          resultsHTML+=`<div class="stagger-item flex items-stretch gap-4 p-4 mb-3 border border-border-color rounded-xl transition-all duration-300 hover:shadow-lg hover:border-primary/50 hover:bg-primary/5 hover:scale-[1.02]" style="animation-delay: ${resultCounter * 70}ms"><div class="calendar-icon"><div class="month">${month}</div><div class="day">${day}</div></div><div class="flex-grow"><p class="font-bold text-foreground-primary">${e.Corso.replace(/_/g,' ')}</p><p class="text-sm">${e.Sede}</p><p class="text-xs mt-1"><span class="font-semibold">Orario:</span> ${e.Ora}</p></div><div class="flex items-center"><button onclick='addToGoogleCalendar(${examJson})' class='btn btn-secondary !py-1.5 !px-3 !text-xs !rounded-md'>Calendario</button></div></div>`;
          resultCounter++;
        });
      });
      out.innerHTML = resultsHTML;
    }

    // ===== Persistenza piani (LOGICA NON MODIFICATA) =====
    document.getElementById('save-plan-btn')?.addEventListener('click',()=>{
      if(!currentPlan.length) return;
      const saved=JSON.parse(localStorage.getItem('examPlans')||'[]');
      saved.unshift({ date:new Date().toISOString(), plan: currentPlan.map(c=>({...c, dt:c.dt.toISOString()})) });
      localStorage.setItem('examPlans', JSON.stringify(saved));
      displaySavedPlans(); showToast('Piano salvato!');
    });
    function loadSavedPlan(i){ const saved=JSON.parse(localStorage.getItem('examPlans')||'[]'); if(i>=saved.length) return; displayResults({ chosen:saved[i].plan, stats:{} }); document.getElementById('results-container').scrollIntoView({behavior:'smooth'}); }
    function displaySavedPlans(){
      const saved=JSON.parse(localStorage.getItem('examPlans')||'[]');
      const cont=document.getElementById('saved-plans-container'), out=document.getElementById('saved-plans');
      if(!saved.length){ cont.classList.add('hidden'); return; }
      
      cont.classList.remove('hidden');
      if(!cont.classList.contains('fade-in-up')) {
        cont.classList.add('fade-in-up');
      }

      out.innerHTML='';
      saved.forEach((s,idx)=>{
        const when=new Date(s.date).toLocaleString('it-IT'); const sedi=[...new Set(s.plan.map(p=>p.Sede))].join(', ');
        out.innerHTML += `<div class="p-4 border border-border-color rounded-lg flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 transition-all duration-300 cursor-pointer hover:shadow-md hover:border-primary/30 dark:hover:border-primary/30 hover:bg-primary/5 dark:hover:bg-primary/10" onclick="loadSavedPlan(${idx})"><div class="flex-1 text-left w-full"><div class="font-semibold text-foreground-primary text-sm">Salvataggio del ${when}</div><p class="text-xs text-foreground-muted mt-1">${s.plan.length} esami ¬∑ Sedi: ${sedi}</p></div><button class="btn btn-secondary !py-2 !px-4 !rounded-md w-full sm:w-auto mt-3 sm:mt-0" onclick="event.stopPropagation(); loadSavedPlan(${idx})">Visualizza</button></div>`;
      });
    }
    document.getElementById('clear-plans-btn')?.addEventListener('click',()=>{ if(window.confirm('Eliminare tutti i piani salvati?')){ localStorage.removeItem('examPlans'); displaySavedPlans(); }});
    displaySavedPlans();

    // ===== Run (LOGICA NON MODIFICATA) =====
    document.getElementById('run-btn').addEventListener('click',()=>{
      if(!rawJson.length){ showToast('Seleziona prima un file JSON!', 'error'); return; }
      let sedeVal=document.getElementById('free-sede-select').value; if(sedeVal==='Altro') sedeVal=document.getElementById('free-sede-other').value.trim();
      const params={ max_exams:+document.getElementById('max-exams').value, max_per_day:+document.getElementById('max-per-day').value, min_gap_days:+document.getElementById('min-gap-days').value, min_date:document.getElementById('min-date').value, max_date:document.getElementById('max-date').value, free_sede_exact:sedeVal, max_sedi:+document.getElementById('max-sedi').value || Infinity, locked_ids:[...pickedInclude], excluded_ids:[...pickedExclude] };
      const res=optimize(rawJson, params);
      displayResults(res);
      document.getElementById('results-container').scrollIntoView({behavior:'smooth'});
    });
    
    // ===== Custom Select (LOGICA NON MODIFICATA) =====
    function setupCustomSelects() {
        document.querySelectorAll('select').forEach(selectElement => {
            const container = document.createElement('div');
            container.className = 'custom-select-container';

            const parent = selectElement.parentNode;
            if (parent.classList.contains('custom-select-container')) {
                 parent.parentNode.replaceChild(selectElement, parent);
            }
            selectElement.parentNode.replaceChild(container, selectElement);
            container.appendChild(selectElement);
            
            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';

            const selectedDisplay = document.createElement('span');
            selectedDisplay.textContent = selectElement.options[selectElement.selectedIndex].textContent;
            
            const arrow = document.createElement('div');
            arrow.innerHTML = `<svg class="w-5 h-5 text-foreground-muted transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>`;

            if (selectElement.classList.contains('date-pill')) {
                trigger.className += ' date-pill !py-1 !px-2';
            } else {
                trigger.className += ' w-full input-base px-3 py-2.5';
                trigger.style.height = '2.75rem';
            }
            
            trigger.appendChild(selectedDisplay);
            trigger.appendChild(arrow);
            container.appendChild(trigger);
            
            const options = document.createElement('div');
            options.className = 'custom-select-options card';
            if (selectElement.classList.contains('date-pill')) {
                options.style.minWidth = '160px';
            }

            Array.from(selectElement.options).forEach(option => {
                if (option.value === "" && selectElement.id.startsWith('quick-date')) return;
                
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-select-option';
                optionEl.textContent = option.textContent;
                optionEl.dataset.value = option.value;
                
                if (option.selected) {
                    optionEl.classList.add('selected');
                }

                optionEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectElement.value = option.value;
                    selectElement.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    if (selectElement.id.startsWith('quick-date-select')) {
                        selectedDisplay.textContent = selectElement.options[0].textContent;
                    } else {
                        selectedDisplay.textContent = option.textContent;
                        options.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                        optionEl.classList.add('selected');
                    }
                    closeAllSelects();
                });
                options.appendChild(optionEl);
            });
            container.appendChild(options);

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = options.classList.contains('open');
                closeAllSelects();
                if (!isOpen) {
                    options.classList.add('open');
                    arrow.firstElementChild.style.transform = 'rotate(180deg)';
                }
            });
        });
    }

    function closeAllSelects() {
        document.querySelectorAll('.custom-select-options.open').forEach(options => {
            options.classList.remove('open');
            const arrow = options.previousElementSibling.querySelector('svg');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
    }
    
    document.addEventListener('click', closeAllSelects);
    window.addEventListener('load', setupCustomSelects);

    // init
    buildExamList(); updateManualSelectionSummary();
  </script>
</body>
</html>